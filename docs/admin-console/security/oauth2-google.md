---
title: OAuth2 - Google IdP
hide_title: true
sidebar_position: 5
---
# Google as OAuth2 identity provider

This section provides specific information for setting up OAuth 2.0 for Thabala in GitHub. There are two tasks to complete:

* Create an Application in Google Cloud Platform
* Configure the Thabala Admin Console

## Create an Application in Google Cloud Platform

1. In [Google Cloud Platform](https://console.cloud.google.com) open **APIs & Services > Credentials**.
2. Click **+ CREATE CREDENTIALS** and **OAuth client ID > Web application**
3. Fill the form as per below:
* **Name**: Anything meaningful, a good name could be `Thabala Admin Console`
* **Authorised redirect URIs**: `https://<thabala-account-domain-name>/oauth-authorized`. This value is unique for your Thabala account.
You can get the full redirect URL in the Thabala Admin Console under the **Authenticator** menu item.
Check the screenshot in the [Configure the Thabala Admin Console](#configure-the-thabala-admin-console) section.

:::info

To allow browser based authentication for the Thabala CLI add a secondary **Sign-in redirect URI**: `http://localhost:53442`.

:::

Once the app is created Google Admin Console you will generate a **Client ID** and a **Client Secret**. Put them into a safe place, you will need them in the following steps.

## Configure the Thabala Admin Console

In the Thabala Admin Console go to the **Security -> Authenticator** menu item, select **Google** as the authenticator and fill
the form as per the below:

* **Api Base URL**: `https://www.googleapis.com/oauth2/v2/`
* **Authorize URL**: `https://accounts.google.com/o/oauth2/auth`
* **Access Token URL**: `https://accounts.google.com/o/oauth2/token`
* **Server Metadata URL**: `https://accounts.google.com/.well-known/openid-configuration`
* **Client ID**: Client ID generated by the Google Admin Console in the previous point
* **Client Secret**: Client Secret generated by the Google Admin Console in the previous point

![Example banner](./assets/authenticator-google.png)

:::caution

Make sure to use the correct Authorised redirect URL in the GitHub OAuth App settings to match the
one that is generated by the Thabala Admin Console. Highlighted in the screenshot above.

:::

## Configure it in the Thabala CLI

Optionally you can configure OAuth2 as YAML using the `Authenticator` kind and can apply it by the [Thabala CLI](/thabala-cli).

```yaml
kind: Authenticator
authenticator:
  authenticator: google
  oauth2:
    remote_app:
      api_base_url: https://www.googleapis.com/oauth2/v2/
      authorize_url: https://accounts.google.com/o/oauth2/auth
      access_token_url: https://accounts.google.com/o/oauth2/token
      server_metadata_url: https://accounts.google.com/.well-known/openid-configuration
      client_id: enc/<encrypted-string>
      client_secret: enc/<encrypted-string>
```

:::info

The `client_id` and `client_secret` values are automatically encrypted and identified by the `enc/` prefix.
Based on your security requirements if you don't like the auto encrypted values in the YAML files then you
can use secure variables which are replaced to the actual values at runtime. Using this method
you do not need to keep encrypted secrets in YAML files and in your version control system.

:::

## Validate Google OAuth2 in the Thabala Web Login Page

If everything set up correctly then you should see the `Single Sign On` button on the Thabala login screen.
Clicking on it you should be redirected to the Google authentication screen.

<div style={{textAlign: 'center'}}>

![Example banner](./assets/authenticator-sso-login.png)

</div>

:::info

Username and Password fields are still visible but this option is working only for special users who are
explicitly allowed to be authenticated without OAuth2.

:::

## Validate Google OAuth2 by the Thabala CLI

Users of the Thabala CLI can be authenticated by Google OAuth2 by setting the `authenticator` to `EXTERNALBROWSER` in the
`~/.config/thabala/cli.cfg` config file. When using the external browser authenticator the `username` and `password`
need to be empty.

`~/.config/thabala/cli.cfg`:
```yaml
[default]
account_url = https://th12345.us-east-1.thabala.com
authenticator = EXTERNALBROWSER
username =
password =
```

If the Thabala CLI is configured to use the `EXTERNALBROWSER` authenticator then it pops up the Google
authentication page in your default browser when running a CLI command.
For example running the `thabala get service-instances` command you should see the Google authentication page
in your default browser and the command should act as below:

```commandline
$ thabala get service-instances
Initiating login request with your identity provider. A browser window should have opened for you to complete the login. If you can't see it, check existing browser windows, or your OS settings. Press CTRL+C to abort and try again...
{
    "result": [],
    "total_entries": 0
}
```
